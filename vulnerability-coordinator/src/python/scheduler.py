from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.interval import IntervalTrigger
import atexit
import os
import logging
logger = logging.getLogger(__name__)

CACHE_REFRESH_MINUTE_INTERVAL = int(os.getenv("CACHE_REFRESH_MINUTE_INTERVAL"))
CHECK_REMOTE_SCANNER_METADATA_INTERVAL = int(os.getenv("CHECK_REMOTE_SCANNER_METADATA_INTERVAL"))
PURGE_SCAN_CACHE_INTERVAL = int(os.getenv("PURGE_SCAN_CACHE_INTERVAL"))
SCAN_NODES = os.getenv("SCAN_NODES", "false").lower() in ("true", "1", "yes")
SCAN_CONTAINERS = os.getenv("SCAN_CONTAINERS", "false").lower() in ("true", "1", "yes")

def refresh_cache_job():
    from vulnerability_coordinator import reset_container_cache, reset_node_cache
    logger.info("refresh_container_cache_job()")
    if SCAN_CONTAINERS:
        reset_container_cache()
    if SCAN_NODES:
        reset_node_cache()

def init_scanner_db_metadata():
    logger.info("init_scanner_db_metadata()")
    from file_manager import load_scanner_database_metadata_from_disk, store_scanner_database_metadata
    from pod_scanner import retrieve_current_scanner_db_metadata
    #Ensure we have scanner metadata locally
    if load_scanner_database_metadata_from_disk() is None:
        print("init_scanner_db_metadata(), no metadata, init")
        # Load it and store it
        metadata = retrieve_current_scanner_db_metadata()
        store_scanner_database_metadata(metadata)
    else:
        print("init_scanner_db_metadata(), metadata exists, ignore")

def check_remote_scanner_db_change_job():
    logger.info("check_remote_scanner_db_change_job()")
    from file_manager import load_scanner_database_metadata_from_disk, store_scanner_database_metadata, append_to_log_file
    from pod_scanner import retrieve_current_scanner_db_metadata
    from vulnerability_coordinator import rescan_all_images, rescan_all_nodes
    current_metadata = load_scanner_database_metadata_from_disk()
    latest_metadata = retrieve_current_scanner_db_metadata()

    if current_metadata != latest_metadata:
        logger.info("check_remote_scanner_db_change_job() - data changed, trigger refresh")
        append_to_log_file("check_remote_scanner_db_change_job() - data changed, trigger refresh", "check_remote_scanner_db_change_job.log")
        store_scanner_database_metadata(latest_metadata)
        #Trigger refresh!!!!!
        if SCAN_CONTAINERS:
            rescan_all_images()
        if SCAN_NODES:
            rescan_all_nodes()
    else:
        logger.info("check_remote_scanner_db_change_job() - No change, do nothing")
        append_to_log_file("check_remote_scanner_db_change_job() - No change, do nothing", "check_remote_scanner_db_change_job.log")

def purge_scan_cache_job():
    logger.info("purge_scan_cache_job()")
    from file_manager import list_scans_on_disk, delete_scan
    from vulnerability_coordinator import get_node_list, get_image_id_list
    scans_on_disk_set = set(list_scans_on_disk())
    node_list = get_node_list()
    image_id_list = get_image_id_list()

    # Remove all items in node_list and image_id_list from scans_on_disk_set
    scans_on_disk_set.difference_update(node_list)
    scans_on_disk_set.difference_update(image_id_list)

    for scan in scans_on_disk_set:
        logger.info(f"purge_scan_cache_job() - Delete scan {scan}")
        delete_scan(scan)

    logger.info("purge_scan_cache_job() - Complete")

def init_scheduler():
    logger.info("init_scheduler()")
    logger.info(f"refresh_container_cache_job every {CACHE_REFRESH_MINUTE_INTERVAL} minutes")
    logger.info(f"check_remote_scanner_db_change_job every {CHECK_REMOTE_SCANNER_METADATA_INTERVAL} minutes")

    init_scanner_db_metadata()

    scheduler = BackgroundScheduler()
    scheduler.add_job(func=refresh_cache_job, 
                        trigger=IntervalTrigger(minutes=CACHE_REFRESH_MINUTE_INTERVAL), 
                        id='refresh_cache_job', 
                        name='Refresh the cache', 
                        replace_existing=True)
    scheduler.add_job(func=check_remote_scanner_db_change_job, 
                        trigger=IntervalTrigger(minutes=CHECK_REMOTE_SCANNER_METADATA_INTERVAL), 
                        id='check_remote_scanner_db_change_job', 
                        name='Check if scanner DB has changed', 
                        replace_existing=True)

    scheduler.add_job(func=purge_scan_cache_job, 
                        trigger=IntervalTrigger(minutes=PURGE_SCAN_CACHE_INTERVAL), 
                        id='purge_scan_cache_job', 
                        name='Purge scan cache', 
                        replace_existing=True)

    scheduler.start()
    atexit.register(lambda: scheduler.shutdown())
