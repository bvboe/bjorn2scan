import os
import shutil
from datetime import datetime
import subprocess
import json
import logging
logger = logging.getLogger(__name__)

SCAN_DATA_DIRECTORY = os.getenv("SCAN_DATA_DIRECTORY")
CACHE_DIRECTORY = os.getenv("CACHE_DIRECTORY")
LOG_DIRECTORY = os.getenv("LOG_DIRECTORY")

SBOM_FILENAME = "sbom.json"
STATUS_FILENAME = "status.txt"
NO_DISTRO_NAME = "None"

#Create directories
os.makedirs(SCAN_DATA_DIRECTORY, exist_ok=True)
os.makedirs(CACHE_DIRECTORY, exist_ok=True)
os.makedirs(LOG_DIRECTORY, exist_ok=True)

def generate_path(image_id, filename):
    return SCAN_DATA_DIRECTORY+"/"+image_id+"/"+filename

def sbom_exists(image_id):
    logger.debug(f"sbom_exists({image_id})")
    file_path=generate_path(image_id, SBOM_FILENAME)
    return os.path.isfile(file_path)

def store_sbom(image_id, sbom):
    logger.debug(f"store_sbom({image_id}, ...)")
    #Create directory if it doesn't exist
    sbom_directory = SCAN_DATA_DIRECTORY + "/" + image_id
    sbom_file = sbom_directory + "/" + SBOM_FILENAME
    os.makedirs(sbom_directory, exist_ok=True)
    with open(sbom_file, 'w') as file:
        # Write SBOM
        file.write(sbom)

def store_scan_status(image_id, status):
    logger.debug(f"store_scan_status({image_id}, {status})")
    #Create directory if it doesn't exist
    status_directory = SCAN_DATA_DIRECTORY + "/" + image_id
    status_file = status_directory + "/" + STATUS_FILENAME
    os.makedirs(status_directory, exist_ok=True)
    with open(status_file, 'w') as file:
        # Write status
        file.write(status)

def load_scan_status(image_id):
    logger.debug(f"load_scan_status({image_id})")
    scan_status = load_container_file(image_id, STATUS_FILENAME)
    if scan_status == None:
        return "TO_BE_SCANNED"
    else:
        return scan_status

def add_to_sbom_log(*strings):
    log_message = " ".join(strings)
    append_to_log_file(log_message, "sbom.log")

def add_to_sbom_error_log(*strings):
    log_message = " ".join(strings)
    append_to_log_file(log_message, "sbom-err.log")

def append_to_log_file(log_message, filename):
    timestamp_str = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    log_string = (f"{timestamp_str}: {log_message}\n")
    log_file = LOG_DIRECTORY + "/" + filename
    with open(log_file, 'a') as file:
        # Write log
        file.write(log_string)

def call_process_sbom_script(image_id):
    logger.debug(f"call_process_sbom_script({image_id})")
    directory = SCAN_DATA_DIRECTORY + "/"+image_id
    try:
        script_call = ["./process_sbom.sh", directory]
        result = subprocess.run(script_call, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, check=True)
        logger.debug(result.stdout)
    except subprocess.CalledProcessError as e:
        logger.error(f"Command failed with return code {e.returncode}")
        logger.error(f"Command output:\n{e.output}")
        logger.error(f"Command error:\n{e.stderr}")
    except FileNotFoundError:
        logger.error("The specified command was not found.")
    except Exception as e:
        logger.error(f"An unexpected error occurred: {e}")

def call_generate_shared_data_script():
    logger.debug(f"call_generate_shared_data_script()")
    try:
        script_call = ["./update_shared_metadata.sh", SCAN_DATA_DIRECTORY, CACHE_DIRECTORY]
        result = subprocess.run(script_call, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, check=True)
        logger.debug(result.stdout)
    except subprocess.CalledProcessError as e:
        logger.error(f"Command failed with return code {e.returncode}")
        logger.error(f"Command output:\n{e.output}")
        logger.error(f"Command error:\n{e.stderr}")
    except FileNotFoundError:
        logger.error("The specified command was not found.")
    except Exception as e:
        logger.error(f"An unexpected error occurred: {e}")

def load_vulnerability_summary(container_id):
    #logger.debug(f"load_vulnerability_summary({container_id})")
    str_result = load_container_file(container_id, "vulnerability-scan-summary.json")
    if str_result is None:
        return {}
    else:
        return json.loads(str_result)

def load_vulnerability_scan(container_id):
    #logger.debug(f"load_vulnerability_scan({container_id})")
    str_result = load_container_file(container_id, "vulnerability-scan-short.json")
    if str_result is None:
        #Scan doesn't exist, that's ok, return None as an empty scan result would be an empty array
        return None
    else:
        return json.loads(str_result)


def load_container_file(container_id, file_name):
    #logger.debug(f"load_container_file({container_id}, {file_name})")
    file_path = SCAN_DATA_DIRECTORY + "/" + container_id + "/" + file_name
    #logger.debug(f"Load file {file_path}")

    return load_file(file_path)

def load_shared_metadata():
    logger.debug("load_shared_metadata()")
    data = load_file(CACHE_DIRECTORY + "/metadata.json")
    if data is None:
        return {}
    else:
        return json.loads(data)

def load_file(file_path):
    try:
        with open(file_path, 'r') as file:
            result = file.read()
            return result
    except FileNotFoundError:
        # No file, return None
        #logger.debug(f"The file {file_path} does not exist.")
        return None

def load_sbom(container_id):
    #logger.debug(f"load_sbom({container_id})")

    str_result = load_container_file(container_id, "sbom-short.json")
    if str_result is None:
        #Scan doesn't exist, that's ok, return None as an empty scan result would be an empty array
        return None
    else:
        return json.loads(str_result)

def load_sbom_summary(container_id):
    #logger.debug(f"load_sbom_summary({container_id})")
    str_result = load_container_file(container_id, "sbom-summary.json")

    if str_result is None:
        #SBOM doesn't exist, that's ok, return None as an empty scan result would be an empty array
        return None
    else:
        return json.loads(str_result)

def get_distro_name(container_id):
    sbom_summary = load_sbom_summary(container_id)
    if sbom_summary is None:
        return NO_DISTRO_NAME

    if sbom_summary.get('distro') is None:
        return NO_DISTRO_NAME

    if sbom_summary['distro'].get('prettyName') is None:
        return NO_DISTRO_NAME

    return sbom_summary['distro']['prettyName']

def load_scanner_database_metadata_from_disk():
    logger.debug("load_scanner_database_metadata_from_disk()")
    result = load_file(CACHE_DIRECTORY + "/" + "grype-db-metadata.json")
    if result is None:
        return None
    else:
        return json.loads(result)

def store_scanner_database_metadata(metadata):
    with open(CACHE_DIRECTORY + "/" + "grype-db-metadata.json", 'w') as file:
        # Write log
        file.write(json.dumps(metadata))

def list_scans_on_disk():
    logger.debug("list_scans_on_disk()")
    try:
        # List all directories in the scan directory
        directories = [
            entry for entry in os.listdir(SCAN_DATA_DIRECTORY)
            if os.path.isdir(os.path.join(SCAN_DATA_DIRECTORY, entry))
        ]

        #logger.debug(f"Found directories: {directories}")
        return directories
    except Exception as e:
        logger.error(f"Error listing scans on disk: {e}")
        return []

def delete_scan(scan):
    logger.debug(f"delete_scan({scan})")
    full_scan_directory = SCAN_DATA_DIRECTORY + "/" + scan

    try:
        # Check if the directory exists before attempting to delete it
        if os.path.exists(full_scan_directory):
            shutil.rmtree(full_scan_directory)  # Delete the directory and its contents
            logger.debug(f"Successfully deleted scan directory: {full_scan_directory}")
        else:
            logger.error(f"Scan directory does not exist: {full_scan_directory}")
    except Exception as e:
        logger.error(f"Error deleting scan directory {full_scan_directory}: {e}")